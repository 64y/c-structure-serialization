CC := gcc
LD := gcc

INCLUDE_DIR := include
SOURCE_DIR := src
OBJECT_DIR := obj
LIBRARY_DIR := lib
LIBRARY := libcstructureserialization.a

SOURCES := src/c_structure_serialization/serializer.c # $(shell find $(SOURCE_DIR) -type f -name *.c)
OBJECTS := $(patsubst $(SOURCE_DIR)/%, $(OBJECT_DIR)/%, $(SOURCES:.c=.o))

CFLAGS := -Wall -g -fPIC
LFLAGS := -ldl -lcrypto
INC := -I $(INCLUDE_DIR)
INC_DEP := -I $(INCLUDE_DIR)

library: directories $(LIBRARY)

remake: clean library

clean:
	@$(RM) -rf $(OBJECT_DIR)
	@$(RM) -rf $(LIBRARY_DIR)

directories:
	@mkdir -p $(OBJECT_DIR)
	@mkdir -p $(LIBRARY_DIR)

-include $(OBJECTS:.o=.d)

$(LIBRARY): $(OBJECTS)
	@ar -cvq $(LIBRARY_DIR)/$(LIBRARY) $^

$(OBJECT_DIR)/%.o: $(SOURCE_DIR)/%.c
	@mkdir -p $(dir $@)
	@$(CC) $(CFLAGS) $(LFLAGS) $(INC) -c -o $@ $<
	@$(CC) $(CFLAGS) $(INC_DEP) -MM $(SOURCE_DIR)/$*.c > $(OBJECT_DIR)/$*.d
	@cp -f $(OBJECT_DIR)/$*.d $(OBJECT_DIR)/$*.d.tmp
	@sed -e 's|.*:|$(OBJECT_DIR)/$*.o:|' < $(OBJECT_DIR)/$*.d.tmp > $(OBJECT_DIR)/$*.d
	@sed -e 's/.*://' -e 's/\\$$//' < $(OBJECT_DIR)/$*.d.tmp | fmt -1 | sed -e 's/^ *//' -e 's/$$/:/' >> $(OBJECT_DIR)/$*.d
	@rm -f $(OBJECT_DIR)/$*.d.tmp

.PHONY: library remake clean directories
